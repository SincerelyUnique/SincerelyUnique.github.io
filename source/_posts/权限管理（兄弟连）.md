---
title: æƒé™ç®¡ç†ï¼ˆå…„å¼Ÿè¿ï¼‰
date: 2022-08-09 14:34:43
tags:
categories:
valine:
  placeholder: "1. æé—®å‰è¯·å…ˆä»”ç»†é˜…è¯»æœ¬æ–‡æ¡£âš¡\n2. é¡µé¢æ˜¾ç¤ºé—®é¢˜ğŸ’¥ï¼Œè¯·æä¾›æ§åˆ¶å°æˆªå›¾ğŸ“¸æˆ–è€…æ‚¨çš„æµ‹è¯•ç½‘å€\n3. å…¶ä»–ä»»ä½•æŠ¥é”™ğŸ’£ï¼Œè¯·æä¾›è¯¦ç»†æè¿°å’Œæˆªå›¾ğŸ“¸ï¼Œç¥é£Ÿç”¨æ„‰å¿«ğŸ’ª"
---

# ACLæƒé™

## ACLæƒé™ç®€ä»‹ä¸å¼€å¯

### ACLæƒé™ç®€ä»‹
ä¸¾ä¸€ä¸ªä¾‹å­ï¼Œæ¯”å¦‚æœ‰ä¸€ä¸ªè¯¾å ‚ï¼Œè€å¸ˆéœ€è¦å…±äº«æŸä¸€ä¸ªæ–‡ä»¶å¤¹ç»™å­¦ç”Ÿï¼Œé‚£ä¹ˆæ ¹æ®ugoçš„å®šä¹‰ï¼Œåº”å½“èµ‹äºˆè¿™ä¸ªæ–‡ä»¶u+rwxï¼ˆè€å¸ˆrootèº«ä»½ï¼‰ï¼Œg+rwxï¼ˆå­¦é™¢groupèº«ä»½ï¼‰ï¼Œo-rwxï¼ˆå…¶ä»–äººæ— ä»»ä½•æƒé™ï¼‰æƒé™ï¼Œä¹Ÿå°±æ˜¯770æƒé™ï¼Œä½†æ˜¯å¦‚æœæ­¤æ—¶æ¥äº†ä¸€ä¸ªè¯•å¬å­¦å‘˜ï¼Œå¥¹éœ€è¦rxæƒé™ï¼Œæ€ä¹ˆåˆ†é…æƒé™å‘¢ï¼Œæ³¨æ„ä¸€ä¸ªæ–‡ä»¶åªèƒ½æœ‰ä¸€ä¸ªæ‰€å±ç»„ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸èƒ½å†å»ºç«‹æ–°çš„æ‰€å±ç»„ï¼Œè¿™ä¸ªæ—¶å€™æ²¡æœ‰åŠæ³•coverç¬¬å››é‡èº«ä»½äº†ï¼Œæ­¤æ—¶å°±è½®åˆ°ACLç™»åœºäº†ã€‚è¦å¼€å¯ACLæƒé™ï¼Œé¦–å…ˆè¦è®©æˆ‘ä»¬çš„åˆ†åŒºæ”¯æŒACLæƒé™ã€‚

### æŸ¥çœ‹åˆ†åŒºACLæƒé™æ˜¯å¦å¼€å¯
å‘½ä»¤æ˜¯`dumpe2fs -h /dev/sda3`ï¼Œdumpe2fså‘½ä»¤æ˜¯æŸ¥è¯¢æŒ‡å®šåˆ†åŒºè¯¦ç»†æ–‡ä»¶ç³»ç»Ÿä¿¡æ¯çš„å‘½ä»¤ï¼Œé€‰é¡¹æœ‰`-h`ï¼Œæ˜¯æŒ‡ä»…æ˜¾ç¤ºè¶…çº§å—ä¸­ä¿¡æ¯ï¼Œè€Œä¸æ˜¾ç¤ºç£ç›˜å—ç»„çš„è¯¦ç»†ä¿¡æ¯ã€‚
```bash
[root@core-pods-3 ~]# df -h
Filesystem      Size  Used Avail Use% Mounted on
devtmpfs        494M     0  494M   0% /dev
tmpfs           504M     0  504M   0% /dev/shm
tmpfs           504M   32M  472M   7% /run
tmpfs           504M     0  504M   0% /sys/fs/cgroup
/dev/sda2        22G  3.6G   17G  18% /
/dev/sda1       380M  257M  104M  72% /boot
tmpfs           101M     0  101M   0% /run/user/0

[root@core-pods-3 ~]# dumpe2fs -h /dev/sda2
dumpe2fs 1.42.9 (28-Dec-2013)
Filesystem volume name:   ROOTPART
Last mounted on:          /
Filesystem UUID:          3437f1a0-f850-4f1b-8a7c-819c5f6a29e4
Filesystem magic number:  0xEF53
Filesystem revision #:    1 (dynamic)
Filesystem features:      has_journal ext_attr resize_inode dir_index filetype needs_recovery extent 64bit flex_bg sparse_super large_file huge_file uninit_bg dir_nlink extra_isize
Filesystem flags:         signed_directory_hash 
Default mount options:    user_xattr acl     # æ³¨æ„ï¼šçœ‹è¿™é‡Œï¼Œåˆ†åŒºé»˜è®¤æŒ‚è½½æ—¶å·²ç»æ”¯æŒACLäº†
Filesystem state:         clean
Errors behavior:          Continue
Filesystem OS type:       Linux
Inode count:              1411680
Block count:              5664208
Reserved block count:     283210
Free blocks:              5142565
Free inodes:              1381507
First block:              0
Block size:               4096
Fragment size:            4096
Group descriptor size:    64
Reserved GDT blocks:      459
Blocks per group:         32768
Fragments per group:      32768
Inodes per group:         8160
Inode blocks per group:   510
Flex block group size:    16
Filesystem created:       Mon Mar 13 20:42:02 2017
Last mount time:          Thu Jun 30 05:22:23 2022
Last write time:          Thu Jun 30 05:22:22 2022
Mount count:              6
Maximum mount count:      -1
Last checked:             Thu Jun 30 05:21:29 2022
Check interval:           0 (<none>)
Lifetime writes:          5368 MB
Reserved blocks uid:      0 (user root)
Reserved blocks gid:      0 (group root)
First inode:              11
Inode size:               256
Required extra isize:     28
Desired extra isize:      28
Journal inode:            8
First orphan inode:       397698
Default directory hash:   half_md4
Directory Hash Seed:      a41b78fd-a9ee-4636-9d8c-aec49be071df
Journal backup:           inode blocks
Journal features:         journal_incompat_revoke journal_64bit
Journal size:             64M
Journal length:           16384
Journal sequence:         0x00004c29
Journal start:            6074
```

### ä¸´æ—¶å¼€å¯åˆ†åŒºACLæƒé™
å¦‚æœä¸Šé¢æŸ¥è¯¢æ—¶æ²¡æœ‰æŸ¥åˆ°aclæƒé™ï¼Œå¯ä»¥ä½¿ç”¨å‘½ä»¤ä¸´æ—¶è®¾ç½®æŒ‚è½½aclæƒé™ï¼Œå‘½ä»¤æ˜¯`mount -o remount,acl`ï¼Œ`-o`æ”¯æŒç‰¹æ®ŠæŒ‚è½½é€‰é¡¹ï¼Œè¯¥å‘½ä»¤æ„æ€æ˜¯é‡æ–°æŒ‚è½½æ ¹åˆ†åŒºï¼Œå¹¶åœ¨æŒ‚è½½æ—¶åŠ å…¥aclæƒé™ã€‚

### æ°¸ä¹…å¼€å¯åˆ†åŒºACLæƒé™
linuxæ°¸ä¹…ä¿®æ”¹æŸé¡¹é…ç½®ä¸€èˆ¬éƒ½æ˜¯æ”¹é…ç½®æ–‡ä»¶ï¼Œæˆ‘ä»¬è¿™é‡Œè¦æ”¹çš„æ˜¯`vi /etc/fstab`ï¼Œç„¶åä½¿ç”¨å‘½ä»¤`mount -o remount`é‡æ–°æŒ‚è½½æ–‡ä»¶ç³»ç»Ÿæˆ–é‡å¯ç³»ç»Ÿï¼Œä½¿ä¿®æ”¹ç”Ÿæ•ˆã€‚fstabæ–‡ä»¶æ˜¯ç³»ç»Ÿå¼€æœºè‡ªåŠ¨æŒ‚è½½çš„æ–‡ä»¶ã€‚

```bash
#
# /etc/fstab
# Created by anaconda on Mon Mar 13 20:42:02 2017
#
# Accessible filesystems, by reference, are maintained under '/dev/disk'
# See man pages fstab(5), findfs(8), mount(8) and/or blkid(8) for more info
#
# é€šå¸¸defaultséƒ½æ”¯æŒaclï¼Œå¦‚æœä¸æ”¯æŒï¼Œåœ¨defaultsåé¢åŠ ä»¥ä¸‹å³å¯defaults,discard,noatime,acl
# è¿™é‡Œé€šå¸¸ä¸ä¼šå†™å…¥å…‰ç›˜åˆ†åŒºï¼Œå› ä¸ºå¦‚æœå¯åŠ¨æ—¶å…‰é©±é‡Œæ²¡æœ‰å…‰ç›˜ï¼Œç³»ç»Ÿå¯åŠ¨ä¼šå‡ºç°é—®é¢˜
# æ”¹è¿™ä¸ªæ–‡ä»¶ä¸€å®šè¦å°å¿ƒ
UUID=3437f1a0-f850-4f1b-8a7c-819c5f6a29e4 /                       ext4    defaults,discard,noatime        1 1
UUID=ad1361f7-4ab4-4252-ba00-5d4e5d8590fb /boot                   ext3    defaults,discard,noatime        1 2
/swap  none  swap  sw 0  0
```

## æŸ¥çœ‹ä¸è®¾å®šACLæƒé™

### è®¾å®šACLæƒé™çš„å‘½ä»¤
é¦–å…ˆæˆ‘ä»¬æ¥è®¾å®šACLæƒé™ï¼Œç„¶åå†æŸ¥è¯¢ACLæƒé™ï¼ŒACLæƒé™è®¾å®šçš„å‘½ä»¤æ˜¯`setfacl é€‰çº¿ æ–‡ä»¶å`ï¼Œæœ‰å¦‚ä¸‹é€‰é¡¹ï¼š
- -mï¼šè®¾å®šACLæƒé™ï¼Œè¿™ä¸€èŠ‚ä¸»è¦çœ‹è¿™ä¸ªé€‰é¡¹ï¼
- -xï¼šåˆ é™¤æŒ‡å®šçš„ACLæƒé™
- -bï¼šåˆ é™¤æ‰€æœ‰çš„ACLæƒé™
- -dï¼šè®¾å®šé»˜è®¤ACLæƒé™
- -kï¼šåˆ é™¤é»˜è®¤ACLæƒé™
- -Rï¼šé€’å½’è®¾å®šACLæƒé™

ä»¥æœ€ä¸Šé¢è¯¾å ‚è€å¸ˆå…±äº«æ–‡ä»¶å¤¹ä¸ºä¾‹(ä¸‹é¢æ˜¯åœ¨rootä¸‹æ“ä½œï¼ŒçœŸå®æƒ…å†µä¸æ¨èåœ¨rootç›®å½•ä¸‹åˆ›å»ºæ–‡ä»¶æˆ–æ–‡ä»¶å¤¹)
```bash
[root@core-pods-3 ~]# mkdir project
[root@core-pods-3 ~]# chmod -R 770 project/
[root@core-pods-3 ~]# useradd bimm
[root@core-pods-3 ~]# useradd cangls
[root@core-pods-3 ~]# groupadd tgroup
[root@core-pods-3 ~]# gpasswd -a bimm tgroup
Adding user bimm to group tgroup
[root@core-pods-3 ~]# gpasswd -a cangls tgroup
Adding user cangls to group tgroup
[root@core-pods-3 ~]# cat /etc/group|grep tgroup
tgroup:x:1021:bimm,cangls
[root@core-pods-3 ~]# chown root:tgroup project/
[root@core-pods-3 ~]# ll -d project/
drwxrwx--- 2 root tgroup 4096 Aug  9 11:20 project/
[root@core-pods-3 ~]# useradd st      # æ·»åŠ è¯•å¬ç”¨æˆ·
[root@core-pods-3 ~]# passwd st
[root@core-pods-3 ~]# setfacl -m u:st:rx project/   # ç»™ç”¨æˆ·åˆ†é…aclæƒé™
[root@core-pods-3 ~]# ll -d project/    # æ³¨æ„ä¸‹é¢å‡ºç°çš„â€œ+â€å·
drwxrwx---+ 2 root tgroup 4096 Aug  9 11:20 project/
[root@core-pods-3 ~]# getfacl project/
# file: project/
# owner: root
# group: tgroup
user::rwx
user:st:r-x
group::rwx
mask::rwx
other::---
[root@core-pods-3 ~]# groupadd tgroup2     # ç»™ç»„åˆ†é…aclæƒé™
[root@core-pods-3 ~]# setfacl -m g:tgroup2:rwx project/
```

### æŸ¥çœ‹ACLå‘½ä»¤
é€šå¸¸æŸ¥çœ‹ACLæƒé™çš„å‘½ä»¤æ˜¯`getfacl æ–‡ä»¶å`ï¼Œ

```bash
[root@core-pods-3 ~]# getfacl test.sh 
# file: test.sh
# owner: root
# group: root
user::rwx
group::r--
other::r--
[root@core-pods-3 ~]# getfacl project/
# file: project/
# owner: root
# group: tgroup
user::rwx
user:st:r-x
group::rwx
mask::rwx
other::---
```

## æœ€å¤§æœ‰æ•ˆæƒé™ä¸åˆ é™¤ACLæƒé™

### æœ€å¤§æœ‰æ•ˆæƒé™mask
maskæ˜¯ç”¨æ¥æŒ‡å®šæœ€å¤§æœ‰æ•ˆæƒé™çš„ã€‚å¦‚æœæˆ‘ç»™ç”¨æˆ·èµ‹äºˆäº†ACLæƒé™ï¼Œæ˜¯éœ€è¦å’Œmaskçš„æƒé™â€œç›¸ä¸â€æ‰èƒ½å¾—åˆ°ç”¨æˆ·çš„çœŸæ­£æƒé™ã€‚

|A|B|and|
|---|---|---|
|r|r|r|
|r|-|-|
|-|r|-|
|-|-|-|

```bash
[root@core-pods-3 ~]# getfacl project/
# file: project/
# owner: root
# group: tgroup
user::rwx
user:st:r-x
group::rwx
mask::rwx
other::---
```

æ¯”å¦‚ä¸Šé¢çš„stï¼ˆè¯•å¬ï¼‰ç”¨æˆ·ï¼Œèµ‹äºˆçš„å°±æ˜¯ACLæƒé™r-xï¼Œè€Œmaskæƒé™æ˜¯rwxï¼Œæ‰€ä»¥ä¸æ“ä½œåæ˜¯r-xï¼Œé‚£ä¹ˆstçš„æœ€ç»ˆç”¨æˆ·æƒé™ï¼Œæˆ–è€…è¯´å®é™…ç”¨æˆ·æƒé™å°±æ˜¯r-xï¼Œä¸æ“ä½œå³ï¼š
```
  r - x
& r w x
â€”â€”â€”â€”â€”â€”â€”â€”
  r - x
```

æˆ‘ä»¬å¯ä»¥å°è¯•ä¿®æ”¹æœ€å¤§æƒé™ï¼Œæ¥è¯•å›¾æ”¹å˜stç”¨æˆ·çš„ACLæƒé™ã€‚

```bash
[root@core-pods-3 ~]# setfacl -m m:rx project/
[root@core-pods-3 ~]# getfacl project/
# file: project/
# owner: root
# group: tgroup
user::rwx
user:st:r-x
group::rwx                      #effective:r-x   # æ³¨æ„è¿™é‡Œå¤šå‡ºæ¥çš„ï¼Œæ‰€å±ç»„çœŸå®æƒé™å—å½±å“
group:tgroup2:rwx               #effective:r-x   # æ³¨æ„è¿™é‡Œå¤šå‡ºæ¥çš„ï¼ŒACLç»„çœŸå®æƒé™å—å½±å“
mask::r-x
other::---
```

### åˆ é™¤ACLæƒé™
åˆ é™¤ACLæƒé™çš„å‘½ä»¤æ˜¯`setfacl -x u:ç”¨æˆ·å æ–‡ä»¶å`ï¼Œä½¿ç”¨æ­¤å‘½ä»¤åˆ é™¤æŒ‡å®šç”¨æˆ·çš„ACLæƒé™ã€‚å¯¹äºç”¨æˆ·ç»„ï¼Œå¯ä»¥ä½¿ç”¨å‘½ä»¤`setfacl -x g:ç»„å æ–‡ä»¶å`æ¥åˆ é™¤æŒ‡å®šç”¨æˆ·ç»„çš„ACLæƒé™ã€‚ä¹Ÿå¯ä»¥ä½¿ç”¨é€‰é¡¹`-b`æ¥ç›´æ¥åˆ é™¤æ‰€æœ‰çš„ACLæƒé™ï¼ˆè¿™é‡ŒåŒ…å«ç”¨æˆ·å’Œç”¨æˆ·ç»„ï¼‰ã€‚
```bash
[root@core-pods-3 ~]# setfacl -x g:tgroup2 project/
[root@core-pods-3 ~]# getfacl project/
# file: project/
# owner: root
# group: tgroup
user::rwx
user:st:r-x
group::rwx
mask::rwx
other::---

[root@core-pods-3 ~]# setfacl -b project/
[root@core-pods-3 ~]# getfacl project/
# file: project/
# owner: root
# group: tgroup
user::rwx
group::rwx
other::---

[root@core-pods-3 ~]# ll -d project/     # æ³¨æ„ä¸‹é¢æ²¡æœ‰â€œ+â€å·äº†
drwxrwx--- 2 root tgroup 4096 Aug  9 11:20 project/
[root@core-pods-3 ~]# 
```

## é»˜è®¤ACLæƒé™å’Œé€’å½’ACLæƒé™

### é€’å½’ACLæƒé™
é€’å½’çš„æ„æ€æ˜¯æŒ‡å¯¹çˆ¶ç›®å½•è®¾å®šACLæƒé™æ—¶ï¼Œè¯¥ç›®å½•ä¸‹çš„æ‰€æœ‰å­ç›®å½•å’Œå­æ–‡ä»¶ä¹Ÿä¼šæ‹¥æœ‰ç›¸åŒçš„ACLæƒé™ã€‚è¯¥å‘½ä»¤æ˜¯`setfacl -m u:ç”¨æˆ·å:æƒé™ -R æ–‡ä»¶å`ã€‚æ¼”ç¤ºå¦‚ä¸‹ï¼š

```bash
[root@core-pods-3 ~]# ll project/   # projectç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ªæ–‡ä»¶å¤¹å’Œä¸€ä¸ªæ–‡ä»¶
total 4
drwxr-xr-x 2 root root 4096 Aug  9 23:12 test
-rw-r--r-- 1 root root    0 Aug  9 23:13 test.sh
[root@core-pods-3 ~]# setfacl -m u:st:rx project   # ç»™projectæ–‡ä»¶å¤¹æ·»åŠ ACLæƒé™
[root@core-pods-3 ~]# ll project/     # å‘ç°projectæ–‡ä»¶å¤¹ä¸‹å­æ–‡ä»¶å¤¹å’Œå­æ–‡ä»¶éƒ½è¿˜æ˜¯æ²¡æœ‰ACL
total 4
drwxr-xr-x 2 root root 4096 Aug  9 23:12 test
-rw-r--r-- 1 root root    0 Aug  9 23:13 test.sh
[root@core-pods-3 ~]# setfacl -m u:st:rx -R project   # é‡æ–°ä½¿ç”¨é€’å½’èµ‹äºˆACLæƒé™
[root@core-pods-3 ~]# ll project/    # å‘ç°projectæ–‡ä»¶å¤¹ä¸‹å­æ–‡ä»¶å¤¹å’Œå­æ–‡ä»¶åŒæ—¶æœ‰ACL
total 4
drwxr-xr-x+ 2 root root 4096 Aug  9 23:12 test
-rw-r-xr--+ 1 root root    0 Aug  9 23:13 test.sh
[root@core-pods-3 ~]# cd project/
[root@core-pods-3 project]# touch test1.sh   # ä½†æ˜¯projectç›®å½•ä¸‹åå»ºçš„æ–‡ä»¶å°±æ²¡æœ‰è¿™ä¸ªACLäº†
[root@core-pods-3 project]# ll
total 4
drwxr-xr-x+ 2 root root 4096 Aug  9 23:12 test
-rw-r--r--  1 root root    0 Aug  9 23:16 test1.sh
-rw-r-xr--+ 1 root root    0 Aug  9 23:13 test.sh
```

### é»˜è®¤ACLæƒé™
é»˜è®¤ACLçš„æƒé™çš„ä½œç”¨æ˜¯å¦‚æœç»™çˆ¶ç›®å½•è®¾å®šäº†ACLæƒé™ï¼Œé‚£ä¹ˆçˆ¶ç›®å½•ä¸­æ‰€æœ‰æ–°å»ºçš„å­æ–‡ä»¶éƒ½ä¼šç»§æ‰¿çˆ¶ç›®å½•çš„ACLæƒé™ã€‚ä½†æ˜¯ä»æˆ‘ä»¬ä¸Šä¸€èŠ‚çš„ä¾‹å­å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬æ–°å¢çš„test1.shæ–‡ä»¶æ˜¯æ²¡æœ‰éµå¾ªçˆ¶ç›®å½•çš„ACLæƒé™çš„ï¼Œæ­¤æ—¶æˆ‘ä»¬å¯ä»¥å…ˆä½¿ç”¨å‘½ä»¤`setfacl -m d:u:ç”¨æˆ·å:æƒé™ -R æ–‡ä»¶å`é‡æ–°è®¾ä¸‹projectç›®å½•çš„ACLæƒé™ï¼ˆå‰é¢çš„då°±æ˜¯defaultçš„æ„æ€ï¼‰ï¼Œè¿™æ¡å‘½ä»¤æ˜¯é’ˆå¯¹æœªæ¥æ–°å»ºçš„æ–‡ä»¶ç”Ÿæ•ˆï¼Œå¯¹äºä¹‹å‰çš„æ–‡ä»¶ä¸ç”Ÿæ•ˆã€‚

```bash
[root@core-pods-3 ~]# setfacl -m d:u:st:rx -R project/
[root@core-pods-3 ~]# ll project/
total 4
drwxr-xr-x+ 2 root root 4096 Aug  9 23:12 test
-rw-r--r--  1 root root    0 Aug  9 23:16 test1.sh
-rw-r-xr--+ 1 root root    0 Aug  9 23:13 test.sh
[root@core-pods-3 ~]# touch project/test2.sh
[root@core-pods-3 ~]# ll project/
total 4
drwxr-xr-x+ 2 root root 4096 Aug  9 23:12 test
-rw-r--r--  1 root root    0 Aug  9 23:16 test1.sh
-rw-rw----+ 1 root root    0 Aug  9 23:29 test2.sh
-rw-r-xr--+ 1 root root    0 Aug  9 23:13 test.sh
[root@core-pods-3 ~]# 
```

# æ–‡ä»¶ç‰¹æ®Šæƒé™

## SetUID

### SetUIDçš„åŠŸèƒ½
- åªæœ‰å¯ä»¥æ‰§è¡Œçš„äºŒè¿›åˆ¶ç¨‹åºæ‰èƒ½è®¾å®šSUIDæƒé™ï¼ˆå½“ç„¶æ™®é€šæ–‡ä»¶ä¹Ÿå¯ä»¥è®¾ï¼Œä½†æ˜¯æ²¡æœ‰ä»»ä½•æ„ä¹‰ï¼‰ï¼›
- å‘½ä»¤æ‰§è¡Œè€…è¦å¯¹è¯¥ç¨‹åºæ‹¥æœ‰xï¼ˆæ‰§è¡Œï¼‰æƒé™ï¼ˆå¦‚æœä¸èƒ½æ‰§è¡Œè¯¥æ–‡ä»¶ï¼Œé‚£ä¹Ÿæ²¡æœ‰ä»»ä½•æ„ä¹‰ï¼‰ï¼›
- å‘½ä»¤æ‰§è¡Œè€…åœ¨æ‰§è¡Œè¯¥ç¨‹åºæ—¶è·å¾—è¯¥ç¨‹åºæ–‡ä»¶å±ä¸»çš„èº«ä»½ï¼ˆåœ¨æ‰§è¡Œç¨‹åºçš„è¿‡ç¨‹ä¸­çµé­‚é™„ä½“ä¸ºæ–‡ä»¶çš„å±ä¸»ï¼Œæš‚æ—¶è·å¾—æ–‡ä»¶æ‰€æœ‰è€…èº«ä»½ï¼‰ï¼›
- SetUIDæƒé™åªåœ¨è¯¥ç¨‹åºæ‰§è¡Œè¿‡ç¨‹ä¸­æœ‰æ•ˆï¼Œä¹Ÿå°±æ˜¯è¯´èº«ä»½æ”¹å˜åªåœ¨ç¨‹åºæ‰§è¡Œè¿‡ç¨‹ä¸­æœ‰æ•ˆï¼Œç¨‹åºç»ˆæ­¢ï¼Œèº«ä»½æ¶ˆå¤±ï¼›

ä¸ºä»€ä¹ˆéœ€è¦ä¸€ä¸ªè¿™æ ·çš„åŠŸèƒ½å‘¢ï¼Ÿæˆ‘ä»¬å…ˆçœ‹ä¸€ä¸ªä¾‹å­: ä¸‹é¢çš„passwdäºŒè¿›åˆ¶æ–‡ä»¶çš„æ‰€æœ‰è€…æƒé™æ˜¯rwsï¼Œè¿™ä¹Ÿå°±æ„å‘³ç€åœ¨è¿™ä¸ªæ‰€æœ‰è€…çš„æ‰§è¡Œæƒé™ä½æœ‰SUIDæƒé™ï¼Œå³passwdè¿™æ¡å‘½ä»¤å®ƒæœ‰SUIDçš„æƒé™ã€‚

ä¸ºä»€ä¹ˆè¦ç»™å®ƒSUIDæƒé™å‘¢ï¼Œæˆ‘ä»¬çŸ¥é“ä¸ä»…rootç”¨æˆ·å¯ä»¥ä½¿ç”¨passwdä¿®æ”¹å¯†ç å¹¶å°†å…¶åŠ å¯†å†™å…¥`/etc/shadow`ï¼Œæ™®é€šç”¨æˆ·ä¹Ÿå¯ä»¥æ‰§è¡Œpasswdå°†è‡ªå·±çš„å¯†ç å†™å…¥`/etc/shadow`ï¼Œè€Œshadowè¿™ä¸ªæ–‡ä»¶å…¶å®æ™®é€šç”¨æˆ·æ˜¯æ— æ³•è®¿é—®ä¸”æ— æ³•çœ‹åˆ°çš„ï¼Œé‚£ä¸ºä»€ä¹ˆpasswdå¯ä»¥ä»¥æ™®é€šç”¨æˆ·èº«ä»½æ‰§è¡Œå¹¶ä¿®æ”¹shadowæ–‡ä»¶å‘¢ï¼Ÿ

è¿™å…¶å®è¯´æ˜æ™®é€šç”¨æˆ·åœ¨æ‰§è¡Œpasswdæ—¶ï¼Œå…¶è‡ªèº«æƒé™ä¸´æ—¶å¾—åˆ°äº†æå‡ï¼Œ**æå‡ä¸ºrootç”¨æˆ·çš„æƒé™äº†**ï¼ä¹Ÿå°±æ˜¯æ™®é€šç”¨æˆ·é€šè¿‡rootç”¨æˆ·çš„ä¸´æ—¶èº«ä»½ä¿®æ”¹äº†shadowæ–‡ä»¶ï¼Œå°†å®ƒçš„å¯†ç å†™å…¥è¿›å»ã€‚

ç›¸å¯¹è€Œè¨€catå‘½ä»¤å°±æ²¡æœ‰SUIDçš„æƒé™ï¼Œæ™®é€šç”¨æˆ·ä½¿ç”¨å®ƒæ˜¯æ— æ³•è®¿é—®å’Œä¿®æ”¹shadowæ–‡ä»¶çš„ã€‚

```bash
[root@core-pods-3 ~]# whereis passwd
passwd: /usr/bin/passwd /etc/passwd /usr/share/man/man1/passwd.1.gz /usr/share/man/man5/passwd.5.gz
[root@core-pods-3 ~]# ll /usr/bin/passwd 
-rwsr-xr-x 1 root root 27856 Mar 31  2020 /usr/bin/passwd

[root@core-pods-3 ~]# ll /etc/shadow
---------- 1 root root 2739 Aug  9 11:29 /etc/shadow

[root@core-pods-3 ~]# whereis cat
cat: /usr/bin/cat /usr/share/man/man1/cat.1.gz /usr/share/man/man1p/cat.1p.gz
[root@core-pods-3 ~]# ll /usr/bin/cat
-rwxr-xr-x 1 root root 54080 Nov 16  2020 /usr/bin/cat
```

### è®¾å®šSetUIDçš„æ–¹æ³•
åŸºæœ¬å‘½ä»¤æ˜¯`chmod 4755 æ–‡ä»¶å` æˆ–è€… `chmod u+s æ–‡ä»¶å`ï¼Œå…¶ä¸­ç¬¬ä¸€æ¡å‘½ä»¤çš„4ä»£è¡¨SUIDï¼Œç¬¬äºŒæ¡å‘½ä»¤çš„`+s`ä¹Ÿä»£è¡¨èµ‹äºˆSUIDæƒé™ï¼Œå¦‚æœç¬¬ä¸€æ¡å‘½ä»¤å†™ä¸º2755é‚£ä¹ˆå°±æ˜¯ç»™ç»„èµ‹äºˆSGIDæƒé™ã€‚å¦‚æœæ˜¯1755å°±æ˜¯èµ‹äºˆ SBIDæƒé™ï¼Œå¦‚æœæ˜¯7755å°±æ˜¯åŒ…å«`4+2+1`çš„æ‰€æœ‰SUIDæƒé™ï¼ˆå…¶å®è¿™ç§æ²¡å•¥æ„ä¹‰äº†ï¼‰

### å–æ¶ˆSetUIDçš„æ–¹æ³•
ç›´æ¥æ‰§è¡Œå‘½ä»¤`chmod 755 æ–‡ä»¶å` æˆ–è€… `chmod u-s æ–‡ä»¶å` æŠŠæƒé™æŒ‡å›æ¥å³å¯ã€‚

```bash
[root@core-pods-3 ~]# touch abc
[root@core-pods-3 ~]# ll abc
-rw-r--r-- 1 root root 0 Aug 10 00:43 abc
[root@core-pods-3 ~]# chmod 4755 abc     # è®¾å®šSUIDæƒé™
[root@core-pods-3 ~]# ll abc
-rwsr-xr-x 1 root root 0 Aug 10 00:43 abc
[root@core-pods-3 ~]# chmod 755 abc      # è¦†ç›–SUIDæƒé™
[root@core-pods-3 ~]# ll abc
-rwxr-xr-x 1 root root 0 Aug 10 00:43 abc
[root@core-pods-3 ~]# chmod u+s abc
[root@core-pods-3 ~]# ll abc
-rwsr-xr-x 1 root root 0 Aug 10 00:43 abc
[root@core-pods-3 ~]# chmod 644 abc      # å–æ¶ˆå¯æ‰§è¡Œæƒé™
[root@core-pods-3 ~]# ll abc
-rw-r--r-- 1 root root 0 Aug 10 00:43 abc
[root@core-pods-3 ~]# chmod u+s abc
[root@core-pods-3 ~]# ll abc             # å› ä¸ºæ²¡æœ‰æ‰§è¡Œæƒé™ï¼Œå˜æˆäº†S
-rwSr--r-- 1 root root 0 Aug 10 00:43 abc
[root@core-pods-3 ~]# 
```

ä¸€èˆ¬ç³»ç»Ÿè‡ªå¸¦çš„ä¸€äº›æœ¬èº«åŒ…å«SUIDæƒé™çš„å‘½ä»¤å·²ç»è¶³å¤Ÿæˆ‘ä»¬ä½¿ç”¨äº†ï¼Œæ‰€ä»¥æˆ‘ä»¬å°½å¯èƒ½ä¸è¦å†å»æ‰‹åŠ¨ä¸ºæŸä¸ªå‘½ä»¤è®¾ç½®SUIDæƒé™ï¼Œè¿™æ ·å¯èƒ½ä¼šå‡ºç°ä¸€äº›å®‰å…¨é—®é¢˜ã€‚æ¯”å¦‚è¯´æˆ‘ä»¬ç»™viè®¾ç½®SUIDæƒé™ï¼Œå¦‚ä¸‹ï¼Œè¿™ä¸ªæ—¶å€™å°±å‡ºç°é—®é¢˜äº†ï¼Œæ­¤æ—¶æˆ‘ä»¬æ¢ä¸€ä¸ªæ™®é€šç”¨æˆ·èº«ä»½ç™»å½•sshï¼Œè¿™ä¸ªæ™®é€šç”¨æˆ·å¯ä»¥é€šè¿‡viçš„SUIDæƒé™ç›´æ¥ä¿®æ”¹`/etc/passwd`ï¼Œå°†è‡ªå·±çš„uidæ”¹ä¸º0ï¼ˆä¹Ÿå°±æ˜¯æ”¹æˆå’Œrootç›¸åŒçš„èº«ä»½ï¼‰ï¼Œè¿™ä¸ªæ—¶å€™å°±å‡ºç°æ™®é€šç”¨æˆ·è‡ªå·±ç»™è‡ªå·±èµ‹äºˆrootç”¨æˆ·æƒé™çš„é—®é¢˜äº†ã€‚

```bash
[root@core-pods-3 ~]# whereis vim
vim: /usr/bin/vim /usr/share/vim /usr/share/man/man1/vim.1.gz
[root@core-pods-3 ~]# ll /usr/bin/vim
-rwxr-xr-x 1 root root 2337208 Dec 15  2020 /usr/bin/vim
[root@core-pods-3 ~]# chmod 4755 /usr/bin/vim
[root@core-pods-3 ~]# ll /usr/bin/vim
-rwsr-xr-x 1 root root 2337208 Dec 15  2020 /usr/bin/vim

# æ­¤æ—¶ä½¿ç”¨æ™®é€šç”¨æˆ·èº«ä»½ç™»å½•sshåå¯ä»¥ä¿®æ”¹/etc/passwdç¬¬ä¸‰å­—æ®µUIDï¼Œæ”¹ä¸º0
# å†æ¬¡ä½¿ç”¨è¯¥æ™®é€šç”¨æˆ·èº«ä»½ç™»å½•sshï¼Œå‘ç°å°±æ˜¯rootèº«ä»½
```

### å±é™©çš„SetUID
SUIDæƒé™æ˜¯éå¸¸å±é™©çš„ï¼Œå¦‚æœæ§åˆ¶ä¸ä¸¥æ ¼ä¼šå¸¦æ¥å¾ˆå¤šæ„æƒ³ä¸åˆ°çš„é£é™©ï¼Œæ‰€ä»¥å¯¹äºSUIDï¼Œæˆ‘ä»¬åº”å½“éµå¾ªä¸‹è¿°åŸåˆ™ï¼š
- å…³é”®ç›®å½•åº”è¯¥ä¸¥æ ¼æ§åˆ¶å†™æƒé™ã€‚æ¯”å¦‚â€œ/â€ï¼Œâ€œ/usrâ€ç­‰ã€‚
- ç”¨æˆ·çš„å¯†ç è®¾ç½®è¦ä¸¥æ ¼éµå®ˆå¯†ç ä¸‰åŸåˆ™ã€‚
- å¯¹ç³»ç»Ÿä¸­é»˜è®¤åº”è¯¥å…·æœ‰SetUIDæƒé™çš„æ–‡ä»¶ä½œä¸€åˆ—è¡¨ï¼Œå®šæ—¶æ£€æŸ¥æœ‰æ²¡æœ‰è¿™ä¸ªä¹‹å¤–çš„æ–‡ä»¶è¢«è®¾ç½®äº†SetUIDæƒé™ã€‚

## SetGID

### SetGIDé’ˆå¯¹æ–‡ä»¶çš„ä½œç”¨
è¿™ä¸ªå…¶å®ä¸SetUIDæƒé™çš„æè¿°å¾ˆç›¸ä¼¼ï¼Œåªä¸è¿‡æ˜¯é’ˆå¯¹æ‰€å±ç»„çš„ï¼ŒSetGIDæœ‰å¦‚ä¸‹ä½œç”¨ï¼š
- åªæœ‰å¯ä»¥æ‰§è¡Œçš„äºŒè¿›åˆ¶ç¨‹åºæ‰èƒ½è®¾ç½®SGIDæƒé™ï¼›
- å‘½ä»¤æ‰§è¡Œè€…è¦å¯¹è¯¥ç¨‹åºæ‹¥æœ‰xï¼ˆæ‰§è¡Œï¼‰çš„æƒé™ï¼›
- å‘½ä»¤æ‰§è¡Œåœ¨æ‰§è¡Œç¨‹åºçš„æ—¶å€™ï¼Œç»„èº«ä»½å‡çº§ä¸ºè¯¥ç¨‹åºæ–‡ä»¶çš„å±ç»„ï¼›
- SetGIDæƒé™åŒæ ·åªåœ¨è¯¥ç¨‹åºæ‰§è¡Œè¿‡ç¨‹ä¸­æœ‰æ•ˆï¼Œä¹Ÿå°±æ˜¯è¯´ç»„èº«ä»½æ”¹å˜åªåœ¨ç¨‹åºæ‰§è¡Œè¿‡ç¨‹ä¸­æœ‰æ•ˆï¼›

ä¸¾ä¸ªä¾‹å­ï¼Œæˆ‘ä»¬æ¯”è¾ƒå¸¸ç”¨çš„locateå‘½ä»¤å°±å¯ç”¨äº†SGIDæƒé™ï¼Œé€šè¿‡æŸ¥çœ‹ï¼Œmlocate.dbæƒé™æ˜¯640ï¼Œä¹Ÿå°±æ˜¯æ™®é€šç”¨æˆ·å…¶å®æ²¡æœ‰æƒé™è®¿é—®mlocateè¿™ä¸ªdbçš„ï¼ˆä¸‹è¿°æ“ä½œå¯ä»¥è¯å®ï¼‰ï¼Œä½†æ˜¯äº‹å®ä¸Šæˆ‘ä»¬å¯ä»¥æ‰§è¡Œlocateï¼Œä¹Ÿå°±æ„å‘³ç€æˆ‘ä»¬å¯ä»¥é€šè¿‡locateå‘½ä»¤è®¿é—®mlocateè¿™ä¸ªdbï¼Œä¹Ÿå°±æ˜¯å½“æˆ‘ä½¿ç”¨æ™®é€šç”¨æˆ·æ“ä½œlocateå‘½ä»¤æ—¶ï¼Œå…¶å®ç›¸å½“äºæš‚æ—¶è·å¾—äº†slocateè¿™ä¸ªç»„çš„æƒé™ï¼Œè¯´æ˜åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ç»„æƒé™æœ‰å˜åŒ–ï¼Œæˆ‘ä»¬èƒ½å¤Ÿè¡Œä½¿slocateè¿™ä¸ªç»„çš„ræƒé™ï¼Œæ‰€ä»¥æ™®é€šç”¨æˆ·å¯ä»¥ä½¿ç”¨locateå‘½ä»¤æŸ¥è¯¢mlocate.dbæ•°æ®åº“ã€‚

```bash
# ä¸‹é¢æ˜¯rootç”¨æˆ·èº«ä»½æ“ä½œè®°å½•
[root@core-pods-3 ~]# whereis locate
locate: /usr/bin/locate /usr/share/man/man1/locate.1.gz
[root@core-pods-3 ~]# ll /usr/bin/locate   # å¯ä»¥çœ‹åˆ°æœ‰SGIDæƒé™ï¼Œè‡ªèº«æƒé™711
-rwx--s--x 1 root slocate 40520 Apr 10  2018 /usr/bin/locate
[root@core-pods-3 ~]# ll /var/lib/mlocate/mlocate.db     # å¯ä»¥çœ‹åˆ°è¿™ä¸ªæ•°æ®åº“æƒé™æŒºåˆ«æ‰­ï¼Œ640
-rw-r----- 1 root slocate 2615950 Aug 10 03:09 /var/lib/mlocate/mlocate.db
[root@core-pods-3 ~]# 

# ä¸‹é¢æ˜¯æ™®é€šç”¨æˆ·èº«ä»½æ“ä½œè®°å½•
-bash-4.2$ whoami
st
-bash-4.2$ ll /usr/bin/locate 
-rwx--s--x 1 root slocate 40520 Apr 10  2018 /usr/bin/locate
-bash-4.2$ ll /var/lib/mlocate/mlocate.db
ls: cannot access /var/lib/mlocate/mlocate.db: Permission denied
-bash-4.2$ 

# å¯ä»¥çœ‹åˆ°stç”¨æˆ·æ‰€å±ç»„æ˜¯stï¼ŒGIDæ˜¯1022
-bash-4.2$ grep st /etc/passwd
st:x:666:1022::/home/st:/bin/bash
-bash-4.2$ grep 1022 /etc/group
st:x:1022:

# å°è¯•ä»¥æ™®é€šç”¨æˆ·èº«ä»½æ‰§è¡Œlocateï¼Œå®Œå…¨å¯ä»¥
-bash-4.2$ locate nginx.conf
/etc/nginx/nginx.conf
/etc/nginx/nginx.conf.default
```

### SetGIDé’ˆå¯¹ç›®å½•çš„ä½œç”¨
SGIDä¸SUIDä¸åŒä¹‹å¤„å°±æ˜¯SGIDå¯ä»¥é’ˆå¯¹ç›®å½•æˆæƒã€‚ä¸»è¦æœ‰ä»¥ä¸‹ä½œç”¨ï¼š
- **æ™®é€šç”¨æˆ·**å¿…é¡»å¯¹æ­¤ç›®å½•æ‹¥æœ‰**rå’Œx**æƒé™ï¼Œæ‰èƒ½è¿›å…¥æ­¤ç›®å½•ï¼›
- æ™®é€šç”¨æˆ·åœ¨æ­¤ç›®å½•ä¸­çš„æœ‰æ•ˆç»„ä¼šå˜æˆæ­¤ç›®å½•çš„å±ç»„ï¼›
- è‹¥æ™®é€šç”¨æˆ·å¯¹æ­¤ç›®å½•æ‹¥æœ‰wæƒé™æ—¶ï¼Œæ–°å»ºçš„æ–‡ä»¶çš„é»˜è®¤å±ç»„æ˜¯è¿™ä¸ªç›®å½•çš„å±ç»„ï¼›

è¿™ä¸ªå‘½ä»¤å°±ä¸åƒç»™å¯æ‰§è¡Œæ–‡ä»¶æˆæƒé‚£ä¹ˆå±é™©äº†ï¼Œæˆ‘ä»¬å¯ä»¥ä¸¾ä¸ªä¾‹å­ï¼Œæ³¨æ„ä¸‹é¢åœ¨/tmp/testé‡Œé¢å’Œå¤–é¢åˆ›å»ºæ–‡ä»¶çš„æ‰€å±ç»„ï¼Œå¯ä»¥çœ‹åˆ°stç”¨æˆ·åœ¨å¤–é¢åˆ›å»ºçš„æ–‡ä»¶çš„æ‰€å±ç»„å…¶å®æ˜¯stï¼Œä½†æ˜¯åœ¨testæ–‡ä»¶å¤¹é‡Œé¢åˆ›å»ºçš„æ–‡ä»¶æ‰€å±ç»„éƒ½æ˜¯rootã€‚è¿™å°±æ˜¯SGIDé’ˆå¯¹ç›®å½•çš„ä½œç”¨ï¼Œå…¶å®è¿™ç§åœºæ™¯åœ¨å®é™…ä¸­åº”ç”¨ä¸å¤šã€‚

```bash
[root@core-pods-3 ~]# mkdir /tmp/test
[root@core-pods-3 ~]# chmod 2777 /tmp/test/
[root@core-pods-3 ~]# ll -d /tmp/test/
drwxrwsrwx 2 root root 4096 Aug 10 09:30 /tmp/test/
[root@core-pods-3 ~]# su - st
-bash-4.2$ cd /tmp/
-bash-4.2$ touch abc
-bash-4.2$ ll abc
-rw-rw-r-- 1 st   st      0 Aug 10 09:34 abc
-bash-4.2$ cd /tmp/test/
-bash-4.2$ touch bcd
-bash-4.2$ ll
total 0
-rw-rw-r-- 1 st root 0 Aug 10 09:35 bcd
```

## Sticky BIT
Stickyè‹±æ–‡æ˜¯é»ç€çš„æ„æ€ï¼Œbitæ˜¯ä½ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¹Ÿç§°Sticky BITä½é»ç€ä½ï¼Œè¿™ä¸ªå‘½ä»¤ä¸å±é™©ã€‚SBITé»ç€ä½æœ‰ä»¥ä¸‹ä½œç”¨ï¼š
- é»ç€ä½ç›®å‰åªé’ˆå¯¹ç›®å½•æœ‰æ•ˆï¼›
- æ™®é€šç”¨æˆ·å¯¹è¯¥ç›®å½•æ‹¥æœ‰wå’Œxæƒé™ï¼Œå³æ™®é€šç”¨æˆ·å¯ä»¥åœ¨æ­¤ç›®å½•æ‹¥æœ‰å†™å…¥æƒé™ï¼›
- å¦‚æœæ²¡æœ‰é»ç€ä½ï¼Œå› ä¸ºæ™®é€šç”¨æˆ·æ‹¥æœ‰wæƒé™ï¼Œæ‰€ä»¥å¯ä»¥åˆ é™¤æ­¤ç›®å½•ä¸‹æ‰€æœ‰æ–‡ä»¶ï¼ŒåŒ…æ‹¬å…¶ä»–ç”¨æˆ·å»ºç«‹çš„æ–‡ä»¶ã€‚ä½†æ˜¯å¦‚æœèµ‹äºˆäº†é»ç€ä½ï¼Œé™¤äº†rootå¯ä»¥åˆ é™¤æ‰€æœ‰æ–‡ä»¶ï¼Œæ™®é€šç”¨æˆ·å°±ç®—æ‹¥æœ‰wæƒé™ï¼Œä¹Ÿåªèƒ½åˆ é™¤è‡ªå·±å»ºç«‹çš„æ–‡ä»¶ï¼Œä½†æ˜¯ä¸èƒ½åˆ é™¤å…¶ä»–ç”¨æˆ·å»ºç«‹çš„æ–‡ä»¶ã€‚

/tmpç›®å½•æ˜¯ä¸€ä¸ªå…¸å‹çš„ä¾‹å­ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨å®ƒæ¥æµ‹è¯•ä¸€ä¸‹SBIDçš„åŠŸèƒ½ï¼Œæˆ‘ä»¬ç”¨æ™®é€šç”¨æˆ·st1åˆ›å»º1ä¸ªæ–‡ä»¶ï¼Œç„¶åç”¨æ™®é€šç”¨æˆ·st2å»åˆ é™¤è¯¥æ–‡ä»¶ï¼Œå¯ä»¥å‘ç°æ— æ³•åˆ é™¤ï¼š

```bash
[root@core-pods-3 ~]# ll -d /tmp/      # æ³¨æ„æƒé™ä½æœ€åä¸€ä¸ªå­—æ¯æ˜¯â€œtâ€
drwxrwxrwt. 11 root root 4096 Aug 10 09:51 /tmp/
[root@core-pods-3 ~]# su - st1
Last login: Wed Aug 10 09:52:13 EDT 2022 on pts/1
[st1@core-pods-3 ~]$ touch /tmp/st1-test
[st1@core-pods-3 ~]$ ll /tmp/st1-test 
-rw-rw-r-- 1 st1 st1 0 Aug 10 09:53 /tmp/st1-test
[st1@core-pods-3 ~]$ su - st2
[st2@core-pods-3 ~]$ touch /tmp/st2-test
[st2@core-pods-3 ~]$ ll /tmp/st2-test 
-rw-rw-r-- 1 st2 st2 0 Aug 10 09:53 /tmp/st2-test
[st2@core-pods-3 ~]$ rm -rf /tmp/st1-test 
rm: cannot remove : Operation not permitted
[st2@core-pods-3 ~]$ 
```

è®¾ç½®é»ç€ä½
- chmod 1755 ç›®å½•å
- chmod o+t ç›®å½•å

å–æ¶ˆé»ç€ä½
- chmod 777 ç›®å½•å
- chmod o-t ç›®å½•å

```bash
[root@core-pods-3 ~]# ll -d test
drwxr-xr-x 2 root root 4096 Aug  4 04:24 test
[root@core-pods-3 ~]# chmod 1755 test
[root@core-pods-3 ~]# ll -d test
drwxr-xr-t 2 root root 4096 Aug  4 04:24 test
[root@core-pods-3 ~]# chmod o-t test
[root@core-pods-3 ~]# ll -d test
drwxr-xr-x 2 root root 4096 Aug  4 04:24 test
```

# æ–‡ä»¶ç³»ç»Ÿå±æ€§chattræƒé™

## chattrå‘½ä»¤æ ¼å¼
å‘½ä»¤æ˜¯`chattr [+-=] [é€‰é¡¹] æ–‡ä»¶æˆ–ç›®å½•å`ï¼Œchattrå½’æ ¹ç»“åº•æ˜¯ä¸ºäº†é˜²æ­¢è¯¯æ“ä½œã€‚

æ“ä½œç¬¦æœ‰ï¼š
- +ï¼šå¢åŠ æƒé™
- -ï¼šåˆ é™¤æƒé™
- =ï¼šç­‰äºæŸæƒé™

é€‰é¡¹æœ‰ï¼š
- iï¼šå¦‚æœå¯¹æ–‡ä»¶è®¾ç½®iå±æ€§ï¼Œé‚£ä¹ˆä¸å…è®¸å¯¹æ–‡ä»¶è¿›è¡Œåˆ é™¤ã€æ”¹åï¼Œä¹Ÿä¸èƒ½æ·»åŠ å’Œä¿®æ”¹æ•°æ®ï¼Œç›¸å½“äºæŠŠæ–‡ä»¶é”èµ·æ¥äº†ï¼Œè¯¥æ“ä½œä¹Ÿå¯¹rootç”Ÿæ•ˆï¼Œå‚ç…§ä¸‹æ–¹ç¤ºä¾‹1ï¼›å¦‚æœå¯¹ç›®å½•è®¾ç½®iå±æ€§ï¼Œé‚£ä¹ˆåªèƒ½ä¿®æ”¹ç›®å½•ä¸‹æ–‡ä»¶çš„å±æ€§ï¼Œä½†ä¸å…è®¸å»ºç«‹å’Œåˆ é™¤æ–‡ä»¶ï¼Œç›¸å½“äºé”ç›®å½•ï¼Œå‚ç…§ä¸‹æ–¹ç¤ºä¾‹2ã€‚
- aï¼šå¦‚æœå¯¹æ–‡ä»¶è®¾ç½®aå±æ€§ï¼Œé‚£ä¹ˆåªèƒ½åœ¨æ–‡ä»¶ä¸­å¢åŠ æ•°æ®ï¼Œä½†æ˜¯ä¸èƒ½åˆ é™¤ä¹Ÿä¸èƒ½ä¿®æ”¹æ•°æ®ï¼Œæ¯”ä¸Šé¢çš„iå®½æ¾ï¼Œä¹Ÿå°±æ˜¯æ–‡ä»¶å¯ä»¥åšappendæ“ä½œï¼Œå‚ç…§ç¤ºä¾‹3ï¼›å¦‚æœå¯¹ç›®å½•è®¾ç½®aå±æ€§ï¼Œé‚£ä¹ˆåªå…è®¸åœ¨ç›®å½•ä¸­å»ºç«‹å’Œä¿®æ”¹æ–‡ä»¶ï¼Œä½†æ˜¯ä¸å…è®¸åˆ é™¤ï¼Œå‚ç…§ç¤ºä¾‹4ã€‚

```bash
# ç¤ºä¾‹1
[root@core-pods-3 ~]# touch abc
[root@core-pods-3 ~]# ll abc
-rw-r--r-- 1 root root 0 Aug 10 10:17 abc
[root@core-pods-3 ~]# echo 111 >> abc
[root@core-pods-3 ~]# cat abc
111
[root@core-pods-3 ~]# chattr +i abc          # èµ‹äºˆiæƒé™
[root@core-pods-3 ~]# ll abc
-rw-r--r-- 1 root root 4 Aug 10 10:18 abc
[root@core-pods-3 ~]# lsattr -a abc          # æŸ¥çœ‹iæƒé™
----i--------e-- abc
[root@core-pods-3 ~]# echo 1111 >> abc
-bash: abc: Operation not permitted
[root@core-pods-3 ~]# rm abc
rm: remove regular file ? y
rm: cannot remove : Operation not permitted
[root@core-pods-3 ~]# cat abc
111

# ç¤ºä¾‹2
[root@core-pods-3 ~]# mkdir test
[root@core-pods-3 ~]# touch test/bcd
[root@core-pods-3 ~]# chattr +i test/
[root@core-pods-3 ~]# lsattr -a test/
-------------e-- test/..
----i--------e-- test/.
-------------e-- test/bcd
[root@core-pods-3 ~]# echo 2222 >> test/bcd 
[root@core-pods-3 ~]# cat test/bcd 
2222
[root@core-pods-3 ~]# rm -rf test/bcd 
rm: cannot remove : Operation not permitted
[root@core-pods-3 ~]# touch test/def
touch: setting times of : No such file or directory
[root@core-pods-3 ~]# chattr -i test/
[root@core-pods-3 ~]# rm -rf test/bcd 
[root@core-pods-3 ~]# touch test/cde

# ç¤ºä¾‹3
[root@core-pods-3 ~]# touch cde
[root@core-pods-3 ~]# echo 3333 >> cde 
[root@core-pods-3 ~]# cat cde
3333
[root@core-pods-3 ~]# chattr +a cde
[root@core-pods-3 ~]# echo 444 >> cde
[root@core-pods-3 ~]# cat cde
3333
444
[root@core-pods-3 ~]# vi cde      #  ä¸èƒ½ç”¨viä¿®æ”¹å’Œè¿½åŠ ï¼Œåªèƒ½ç”¨>>è¿½åŠ 
[root@core-pods-3 ~]# echo 555 >> cde
[root@core-pods-3 ~]# cat cde
3333
444
555

# ç¤ºä¾‹4
[root@core-pods-3 ~]# mkdir test2
[root@core-pods-3 ~]# chattr +a test2
[root@core-pods-3 ~]# touch test2/fgh
[root@core-pods-3 ~]# cd test2
[root@core-pods-3 test2]# rm -rf fgh 
rm: cannot remove : Operation not permitted
[root@core-pods-3 test2]# echo 111 >> fgh
[root@core-pods-3 test2]# cat fgh
111
```

## æŸ¥çœ‹æ–‡ä»¶ç³»ç»Ÿå±æ€§
å‘½ä»¤æ˜¯`lsattr é€‰é¡¹ æ–‡ä»¶å`ï¼Œé€‰é¡¹æœ‰ï¼š
- -aï¼šæ˜¾ç¤ºæ‰€æœ‰æ–‡ä»¶å’Œç›®å½•
- -dï¼šè‹¥ç›®æ ‡æ˜¯ç›®å½•ï¼Œä»…åˆ—å‡ºç›®å½•æœ¬èº«çš„å±æ€§ï¼Œè€Œä¸æ˜¯å­æ–‡ä»¶çš„

# ç³»ç»Ÿå‘½ä»¤sudoæƒé™

## sudoæƒé™
å®é™…å·¥ä½œä¸­å¯èƒ½æŸä¸ªäººè´Ÿè´£rootç”¨æˆ·æƒé™ï¼Œæœ‰æ—¶å€™ä¸€ä¸ªäººå¯èƒ½å¿™ä¸è¿‡æ¥ï¼Œä½†æ˜¯æœ‰äº›ä¸œè¥¿åˆè¦ç»™ç»´æŠ¤ï¼Œæ­¤æ—¶rootå¯ä»¥æŠŠä¸€éƒ¨åˆ†åªæœ‰ç®¡ç†å‘˜å¯ä»¥æ‰§è¡Œçš„æƒé™èµ‹äºˆæ™®é€šç”¨æˆ·ã€‚
- rootæŠŠæœ¬æ¥åªèƒ½è¶…çº§ç”¨æˆ·æ‰§è¡Œçš„å‘½ä»¤èµ‹äºˆæ™®é€šç”¨æˆ·æ‰§è¡Œ
- sudoçš„æ“ä½œå¯¹è±¡æ˜¯ç³»ç»Ÿå‘½ä»¤

## sudoä½¿ç”¨
rootç”¨æˆ·å¯ä»¥ä½¿ç”¨`visudo`ç»™æ™®é€šç”¨æˆ·èµ‹äºˆç®¡ç†å‘˜æƒé™ï¼Œå®é™…ä¿®æ”¹çš„æ˜¯`/etc/sudoers`æ–‡ä»¶ã€‚ä¹Ÿå°±æ˜¯è¯´ç›´æ¥viæ”¹è¿™ä¸ªæ–‡ä»¶ä¹Ÿæ˜¯å¯ä»¥çš„

```
root                          ALL=(ALL)                          ALL
ç”¨æˆ·å  è¢«ç®¡ç†ä¸»æœºçš„åœ°å€ï¼ˆè®¿é—®ä¸»æœºï¼‰=ï¼ˆå¯ä½¿ç”¨çš„èº«ä»½ï¼Œå½“æˆrootèº«ä»½ï¼‰   æˆæƒå‘½ä»¤ï¼ˆç»å¯¹è·¯å¾„ï¼‰

%wheel             ALL=(ALL)              ALL
ç»„å    è¢«ç®¡ç†ä¸»æœºçš„åœ°å€=ï¼ˆå¯ä½¿ç”¨çš„èº«ä»½ï¼‰    æˆæƒå‘½ä»¤ï¼ˆç»å¯¹è·¯å¾„ï¼‰
```

```bash
[root@core-pods-3 test2]# man visudo
[root@core-pods-3 test2]# man 5 sudoers
[root@core-pods-3 test2]# vi /etc/sudoers
## Allow root to run any commands anywhere
root    ALL=(ALL)       ALL
## Allows people in group wheel to run all commands
%wheel  ALL=(ALL)       ALL
```

## æˆæƒstç”¨æˆ·å¯ä»¥é‡å¯æœåŠ¡å™¨
æ­¤æ—¶stå¯ä»¥æ‰§è¡Œé‡å¯å‘½ä»¤
```bash
## Allow root to run any commands anywhere
root    ALL=(ALL)       ALL
st      ALL=/sbin/shutdown -r now
```

```bash
[root@core-pods-3 test2]# su - st
Last login: Wed Aug 10 09:51:10 EDT 2022 on pts/1
su: warning: cannot change directory to /home/st: Permission denied
-bash: /home/st/.bash_profile: Permission denied
-bash-4.2$ sudo -l

We trust you have received the usual lecture from the local System
Administrator. It usually boils down to these three things:

    #1) Respect the privacy of others.
    #2) Think before you type.
    #3) With great power comes great responsibility.

[sudo] password for st: 
Matching Defaults entries for st on core-pods-3:
    !visiblepw, always_set_home, match_group_by_gid, always_query_group_plugin, env_reset, env_keep="COLORS DISPLAY HOSTNAME HISTSIZE KDEDIR
    LS_COLORS", env_keep+="MAIL PS1 PS2 QTDIR USERNAME LANG LC_ADDRESS LC_CTYPE", env_keep+="LC_COLLATE LC_IDENTIFICATION LC_MEASUREMENT
    LC_MESSAGES", env_keep+="LC_MONETARY LC_NAME LC_NUMERIC LC_PAPER LC_TELEPHONE", env_keep+="LC_TIME LC_ALL LANGUAGE LINGUAS _XKB_CHARSET
    XAUTHORITY", secure_path=/sbin\:/bin\:/usr/sbin\:/usr/bin

User st may run the following commands on core-pods-3:
    (root) /sbin/shutdown -r now        # æ³¨æ„è¿™é‡Œ
-bash-4.2$ sudo /sbin/shutdown -r now
```

åˆ‡è®°ä¸è¦èµ‹äºˆç”¨æˆ·vimçš„sudoæƒé™ï¼Œå¦åˆ™æ™®é€šç”¨æˆ·å°±å¯ä»¥ä»¥rootèº«ä»½æ”¹ä»»æ„æ–‡ä»¶äº†ï¼Œä¸‹é¢å°±æ˜¯è¿™ä¸ªåä¾‹ï¼š

```bash
## Allow root to run any commands anywhere
root    ALL=(ALL)       ALL
st      ALL=/sbin/shutdown -r now
st1     192.168.0.156=/usr/bin/vim   # æ³¨æ„è¿™é‡Œæ˜¯æœ¬æœºipï¼Œä¸æ˜¯æ¥æºipï¼Œä¹Ÿå°±æ˜¯è¢«è®¿é—®çš„ä¸»æœºip
```
